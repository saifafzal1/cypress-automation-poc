version: '3.8'

services:
  # ── Cypress Test Runner (all tests) ──
  # No local app needed — tests run against https://katalon-demo-cura.herokuapp.com
  cypress:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - CYPRESS_BASE_URL=https://katalon-demo-cura.herokuapp.com
    volumes:
      - ./mochawesome-report:/app/mochawesome-report
      - ./mochawesome-temp:/app/mochawesome-temp
      - ./cypress/videos:/app/cypress/videos
      - ./cypress/screenshots:/app/cypress/screenshots

  # ── Parallel Runners (for Jenkins parallel demo) ──
  cypress-auth:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - CYPRESS_BASE_URL=https://katalon-demo-cura.herokuapp.com
    command: >
      sh -c "npx cypress run --spec 'cypress/e2e/regression/authentication/**'
      && npx mochawesome-merge mochawesome-temp/*.json -o mochawesome-report/auth-merged.json
      && npx marge mochawesome-report/auth-merged.json -f auth-report -o mochawesome-report"
    volumes:
      - ./mochawesome-report:/app/mochawesome-report
      - ./mochawesome-temp/auth:/app/mochawesome-temp
      - ./cypress/videos/auth:/app/cypress/videos
      - ./cypress/screenshots/auth:/app/cypress/screenshots
    profiles:
      - parallel

  cypress-appointment:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - CYPRESS_BASE_URL=https://katalon-demo-cura.herokuapp.com
    command: >
      sh -c "npx cypress run --spec 'cypress/e2e/regression/appointment/**'
      && npx mochawesome-merge mochawesome-temp/*.json -o mochawesome-report/appointment-merged.json
      && npx marge mochawesome-report/appointment-merged.json -f appointment-report -o mochawesome-report"
    volumes:
      - ./mochawesome-report:/app/mochawesome-report
      - ./mochawesome-temp/appointment:/app/mochawesome-temp
      - ./cypress/videos/appointment:/app/cypress/videos
      - ./cypress/screenshots/appointment:/app/cypress/screenshots
    profiles:
      - parallel

  cypress-confirmation:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - CYPRESS_BASE_URL=https://katalon-demo-cura.herokuapp.com
    command: >
      sh -c "npx cypress run --spec 'cypress/e2e/regression/confirmation/**'
      && npx mochawesome-merge mochawesome-temp/*.json -o mochawesome-report/confirmation-merged.json
      && npx marge mochawesome-report/confirmation-merged.json -f confirmation-report -o mochawesome-report"
    volumes:
      - ./mochawesome-report:/app/mochawesome-report
      - ./mochawesome-temp/confirmation:/app/mochawesome-temp
      - ./cypress/videos/confirmation:/app/cypress/videos
      - ./cypress/screenshots/confirmation:/app/cypress/screenshots
    profiles:
      - parallel

  cypress-history:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - CYPRESS_BASE_URL=https://katalon-demo-cura.herokuapp.com
    command: >
      sh -c "npx cypress run --spec 'cypress/e2e/regression/history/**'
      && npx mochawesome-merge mochawesome-temp/*.json -o mochawesome-report/history-merged.json
      && npx marge mochawesome-report/history-merged.json -f history-report -o mochawesome-report"
    volumes:
      - ./mochawesome-report:/app/mochawesome-report
      - ./mochawesome-temp/history:/app/mochawesome-temp
      - ./cypress/videos/history:/app/cypress/videos
      - ./cypress/screenshots/history:/app/cypress/screenshots
    profiles:
      - parallel

  cypress-api:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - CYPRESS_BASE_URL=https://katalon-demo-cura.herokuapp.com
    command: >
      sh -c "npx cypress run --spec 'cypress/e2e/regression/api-validation/**'
      && npx mochawesome-merge mochawesome-temp/*.json -o mochawesome-report/api-merged.json
      && npx marge mochawesome-report/api-merged.json -f api-report -o mochawesome-report"
    volumes:
      - ./mochawesome-report:/app/mochawesome-report
      - ./mochawesome-temp/api:/app/mochawesome-temp
      - ./cypress/videos/api:/app/cypress/videos
      - ./cypress/screenshots/api:/app/cypress/screenshots
    profiles:
      - parallel
